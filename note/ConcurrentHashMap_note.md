注意：时刻注意sizeCtl角色的转变

1、put插值流程（如果保证线程安全）；

1.1、初始化容量及初始化数组（如何保证线程安全）

  在构造方法中，提供了初始容量，计算了 sizeCtl，sizeCtl = 【 (1.5 * initialCapacity + 1)，然后向上取最近的 2 的 n 次方】。如 initialCapacity 为 10，那么得到 sizeCtl 为 16，如果 initialCapacity 为 11，得到 sizeCtl 为 32。

  在initTable方法中主要就是初始化一个合适大小的数组，然后会设置 sizeCtl。初始化方法中的并发问题是通过对 sizeCtl 进行一个 CAS 操作来控制的。 sizeClt最初为数组初始化长度，之后*0.75,角色转换为扩容的阈值；

1.2  链表转换为红黑树，

​        这个方法和 HashMap 中稍微有一点点不同，那就是它不是一定会进行红黑树转换。 treeifyBin 不一定就会进行红黑树转换，也可能是仅仅做数组扩容。如果数组长度小于 64 的时候，其实也就是 32 或者 16 或者更小的时候，会进行数组扩容，不是转换为红黑树

​        通过对头节点加锁保证线程安全；

2  如何实现扩容(翻倍)及数据迁移（协助迁移）；  

​     tryPresize->transfer

​    //  这里的扩容也是做翻倍扩容的，扩容后数组容量为原来的 2 倍

​     对数组中桶的赋值操作使用CAS方式，

​     tryPresize这个方法的核心在于 sizeCtl 值的操作，首先将其设置为一个负数，然后执行 transfer(tab, null)，再下一个循环将 sizeCtl 加 1，并执行 transfer(tab, nt)，之后可能是继续 sizeCtl 加 1，并执行 transfer(tab, nt)。所以，可能的操作就是执行 1 次 transfer(tab, null) + 多次 transfer(tab, nt)，这里怎么结束循环的需要看完 transfer 源码才清楚。

​     transfer将原来的 tab 数组的元素迁移到新的 nextTab 数组中。此方法支持多线程执行，外围调用此方法的时候，会保证第一个发起数据迁移的线程，nextTab 参数为 null，之后再调用此方法的时候，nextTab 不会为 null。nextTab为新数组；

重点：并发迁移的原理：

​    先要理解并发操作的机制。原数组长度为 n，所以我们有 n 个迁移任务，让每个线程每次负责一个小任务是最简单的，每做完一个任务再检测是否有其他没做完的任务，帮助迁移就可以了，而 Doug Lea 使用了一个 stride，简单理解就是步长，每个线程每次负责迁移其中的一部分，如每次迁移 16 个小任务。所以，我们就需要一个全局的调度者来安排哪个线程执行哪几个任务，这个就是属性 transferIndex 的作用。

​     第一个发起数据迁移的线程会将 transferIndex 指向原数组最后的位置，然后从后往前的 stride 个任务属于第一个线程，然后将 transferIndex 指向新的位置，再往前的 stride 个任务属于第二个线程，依此类推。当然，这里说的第二个线程不是真的一定指代了第二个线程，也可以是同一个线程，这个读者应该能理解吧。其实就是将一个大的迁移任务分为了一个个任务包。

​     transfer 这个方法并没有实现所有的迁移任务，每次调用这个方法只实现了 transferIndex 往前 stride 个位置的迁移工作，其他的需要由外围来控制。

3、源码的get操作时，会发现get操作全程是没有加任何锁的，为什么它不需要加锁呢？

1. 计算 hash 值
2. 根据 hash 值找到数组对应位置: (n – 1) & h
3. 根据该位置处结点性质进行相应查找
   - 如果该位置为 null，那么直接返回 null 就可以了
   - 如果该位置处的节点刚好就是我们需要的，返回该节点的值即可
   - 如果该位置节点的 hash 值小于 0，说明正在扩容，或者是红黑树，后面我们再介绍 find 方法
   - 如果以上 3 条都不满足，那就是链表，进行遍历比对即可

​     此方法的大部分内容都很简单，只有正好碰到扩容的情况，ForwardingNode.find(int h, Object k) 稍微复杂一些，不过在了解了数据迁移的过程后，这个也就不难了，所以限于篇幅这里也不展开说了。

4、相对于HashMap,ConcurrentHashMap采取了哪些方式保证线程安全;

5、相对于JDK 1.7 中的实现，JDK 1.8 做的改进有什么优势。







